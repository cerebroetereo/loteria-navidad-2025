<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Participaciones - Loter√≠a de Navidad 2025</title>
    <style>
        /* ============================================
           ESTILOS GLOBALES Y RESET
        ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ============================================
           CONTENEDOR PRINCIPAL
        ============================================ */
        .container {
            max-width: 900px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        /* ============================================
           TIPOGRAF√çA
        ============================================ */
        h1 {
            font-size: 2.5em;
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            font-size: 1.3em;
            color: #667eea;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        /* ============================================
           ESTADOS DE CARGA Y ERROR
        ============================================ */
        #loading {
            text-align: center;
            color: #666;
            font-size: 1.1em;
            padding: 20px;
        }

        #error {
            display: none;
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* ============================================
           SELECTOR DE PARTICIPANTES
        ============================================ */
        .selector-container {
            margin-bottom: 30px;
        }

        label {
            display: block;
            font-size: 1.1em;
            color: #555;
            margin-bottom: 10px;
            font-weight: 600;
        }

        #nombreSelector {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #nombreSelector:hover {
            border-color: #667eea;
        }

        #nombreSelector:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* ============================================
           TARJETA DE INFORMACI√ìN
        ============================================ */
        #infoCard {
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            animation: fadeIn 0.5s ease;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .info-row:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-label {
            font-size: 1em;
            font-weight: 500;
        }

        .info-value {
            font-size: 1.3em;
            font-weight: 700;
        }

        /* ============================================
           TABLA DE PREMIOS
        ============================================ */
        #premiosTable {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 1em;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr:hover {
            background: #f8f9ff;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .premio-emoji {
            font-size: 1.3em;
            margin-right: 8px;
        }

        .premio-nombre {
            font-weight: 600;
            color: #333;
        }

        .premio-cantidad {
            font-weight: 700;
            color: #667eea;
        }

        /* Scroll horizontal en m√≥vil para la tabla */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* ============================================
           FOOTER
        ============================================ */
        footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
            color: #999;
            font-size: 0.9em;
        }

        footer p {
            margin: 5px 0;
        }

        .disclaimer {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        /* ============================================
           ANIMACIONES
        ============================================ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
           RESPONSIVE DESIGN (M√ìVIL < 768px)
        ============================================ */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            th, td {
                padding: 10px;
                font-size: 0.9em;
            }

            .info-value {
                font-size: 1.1em;
            }

            .info-label {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÑ Loter√≠a de Navidad 2025 üéÑ</h1>

        <!-- Estado de carga -->
        <div id="loading">Cargando datos...</div>

        <!-- Mensaje de error -->
        <div id="error"></div>

        <!-- Contenedor del selector -->
        <div class="selector-container" style="display: none;" id="selectorContainer">
            <label for="nombreSelector">Selecciona tu nombre para consultar tus participaciones:</label>
            <select id="nombreSelector">
                <option value="">-- Selecciona tu nombre --</option>
            </select>
        </div>

        <!-- Tarjeta de informaci√≥n -->
        <div id="infoCard">
            <div class="info-row">
                <span class="info-label">üìã N√∫mero de participaciones:</span>
                <span class="info-value" id="numParticipaciones">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">üí∞ Total jugado:</span>
                <span class="info-value" id="totalJugado">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">üìä Porcentaje del d√©cimo:</span>
                <span class="info-value" id="porcentajeDecimo">-</span>
            </div>
        </div>

        <!-- Tabla de premios -->
        <div id="premiosTable">
            <h2>üíé Simulaci√≥n de Premios</h2>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Premio</th>
                            <th>Por D√©cimo Completo</th>
                            <th>Tu Premio (Neto)</th>
                        </tr>
                    </thead>
                    <tbody id="premiosTableBody">
                        <!-- Se generar√° din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p class="disclaimer">Los importes mostrados son NETOS (impuestos ya descontados)</p>
            <p id="lastUpdate">√öltima actualizaci√≥n: <span id="updateTime">-</span></p>
        </footer>
    </div>

    <script>
        /* ============================================
           CONFIGURACI√ìN
        ============================================ */
        const SHEET_ID = '1_qKcfIR2dt6O_yGeEtN9BACDJryVj9U-iNCiCj21Bs0';
        const SHEET_NAME = 'Participantes';
        const POLLING_INTERVAL = 5 * 60 * 1000; // 5 minutos
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

        /* ============================================
           MATRIZ DE PREMIOS (valores netos por d√©cimo completo de 20‚Ç¨)
        ============================================ */
        const PREMIOS = [
            { nombre: 'El Gordo', emoji: 'üèÜ', neto: 328000 },
            { nombre: 'Segundo Premio', emoji: 'ü•à', neto: 108000 },
            { nombre: 'Tercer Premio', emoji: 'ü•â', neto: 48000 },
            { nombre: 'Cuarto Premio', emoji: 'üéñÔ∏è', neto: 20000 },
            { nombre: 'Quinto Premio', emoji: 'üéñÔ∏è', neto: 6000 },
            { nombre: 'Pedrea / Terminaciones', emoji: 'üí∞', neto: 100 },
            { nombre: 'Reintegro', emoji: 'üé´', neto: 20 }
        ];

        /* ============================================
           VARIABLES GLOBALES
        ============================================ */
        let participacionesPorNombre = {}; // Cache de participaciones agregadas
        let intervalId = null; // ID del intervalo de polling

        /* ============================================
           ELEMENTOS DEL DOM
        ============================================ */
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const selectorContainer = document.getElementById('selectorContainer');
        const nombreSelector = document.getElementById('nombreSelector');
        const infoCard = document.getElementById('infoCard');
        const premiosTable = document.getElementById('premiosTable');
        const premiosTableBody = document.getElementById('premiosTableBody');
        const numParticipacionesEl = document.getElementById('numParticipaciones');
        const totalJugadoEl = document.getElementById('totalJugado');
        const porcentajeDecimoEl = document.getElementById('porcentajeDecimo');
        const updateTimeEl = document.getElementById('updateTime');

        /* ============================================
           FUNCI√ìN: PARSEAR CSV MANUALMENTE
        ============================================ */
        function parseCSV(csvText) {
            const lines = csvText.split(/\r?\n/);
            const result = [];

            // Saltar la primera l√≠nea (encabezado)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();

                // Ignorar l√≠neas completamente vac√≠as
                if (!line || line === ',,,,,') continue;

                // Split simple por comas (suficiente para este CSV)
                const columns = line.split(',');

                // Verificar que la columna 1 (Nombre) no est√© vac√≠a
                if (columns.length >= 2 && columns[1] && columns[1].trim()) {
                    result.push({
                        participacion: columns[0] || '',
                        nombre: columns[1].trim(),
                        metodoPago: columns[2] ? columns[2].trim() : ''
                    });
                }
            }

            return result;
        }

        /* ============================================
           FUNCI√ìN: NORMALIZAR NOMBRE
        ============================================ */
        function normalizarNombre(nombre) {
            // Eliminar espacios m√∫ltiples y espacios al inicio/final
            return nombre.trim().replace(/\s+/g, ' ');
        }

        /* ============================================
           FUNCI√ìN: AGREGAR PARTICIPACIONES POR NOMBRE
        ============================================ */
        function agregarParticipaciones(datos) {
            const agregado = {};

            datos.forEach(row => {
                const nombreNormalizado = normalizarNombre(row.nombre);

                if (nombreNormalizado) {
                    if (!agregado[nombreNormalizado]) {
                        agregado[nombreNormalizado] = 0;
                    }
                    agregado[nombreNormalizado]++;
                }
            });

            return agregado;
        }

        /* ============================================
           FUNCI√ìN: POBLAR SELECTOR
        ============================================ */
        function poblarSelector(participaciones) {
            // Obtener nombres √∫nicos y ordenarlos alfab√©ticamente
            const nombres = Object.keys(participaciones).sort((a, b) => 
                a.localeCompare(b, 'es', { sensitivity: 'base' })
            );

            // Limpiar selector excepto la opci√≥n por defecto
            nombreSelector.innerHTML = '<option value="">-- Selecciona tu nombre --</option>';

            // Agregar opciones
            nombres.forEach(nombre => {
                const option = document.createElement('option');
                option.value = nombre;
                option.textContent = nombre;
                nombreSelector.appendChild(option);
            });
        }

        /* ============================================
           FUNCI√ìN: FORMATEAR MONEDA
        ============================================ */
        function formatearMoneda(cantidad) {
            return cantidad.toLocaleString('es-ES') + ' ‚Ç¨';
        }

        /* ============================================
           FUNCI√ìN: ACTUALIZAR INFORMACI√ìN DEL USUARIO
        ============================================ */
        function actualizarInformacion(nombre) {
            const numParticipaciones = participacionesPorNombre[nombre];
            const totalJugado = numParticipaciones * 4;
            const porcentaje = (totalJugado / 20) * 100;

            numParticipacionesEl.textContent = numParticipaciones;
            totalJugadoEl.textContent = formatearMoneda(totalJugado);
            porcentajeDecimoEl.textContent = porcentaje.toFixed(0) + '%';
        }

        /* ============================================
           FUNCI√ìN: GENERAR TABLA DE PREMIOS
        ============================================ */
        function generarTablaPremios(nombre) {
            const numParticipaciones = participacionesPorNombre[nombre];
            const porcentajeUsuario = (numParticipaciones * 4) / 20;

            // Limpiar tabla
            premiosTableBody.innerHTML = '';

            // Generar filas
            PREMIOS.forEach(premio => {
                const premioUsuario = Math.round(premio.neto * porcentajeUsuario);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="premio-emoji">${premio.emoji}</span>
                        <span class="premio-nombre">${premio.nombre}</span>
                    </td>
                    <td class="premio-cantidad">${formatearMoneda(premio.neto)}</td>
                    <td class="premio-cantidad">${formatearMoneda(premioUsuario)}</td>
                `;
                premiosTableBody.appendChild(row);
            });
        }

        /* ============================================
           FUNCI√ìN: MOSTRAR ERROR
        ============================================ */
        function mostrarError(mensaje) {
            errorEl.textContent = mensaje;
            errorEl.style.display = 'block';
            loadingEl.style.display = 'none';
            selectorContainer.style.display = 'none';
        }

        /* ============================================
           FUNCI√ìN: CARGAR DATOS DESDE GOOGLE SHEET
        ============================================ */
        async function cargarDatos() {
            try {
                const response = await fetch(CSV_URL);

                if (!response.ok) {
                    throw new Error('No se pudo acceder a la hoja de c√°lculo. Verifica que sea p√∫blica.');
                }

                const csvText = await response.text();

                // Parsear CSV
                const datos = parseCSV(csvText);

                if (datos.length === 0) {
                    throw new Error('No se encontraron datos v√°lidos en la hoja de c√°lculo.');
                }

                // Agregar participaciones
                participacionesPorNombre = agregarParticipaciones(datos);

                if (Object.keys(participacionesPorNombre).length === 0) {
                    throw new Error('No se encontraron participantes v√°lidos.');
                }

                // Poblar selector
                poblarSelector(participacionesPorNombre);

                // Actualizar timestamp
                updateTimeEl.textContent = new Date().toLocaleString('es-ES');

                // Mostrar interfaz
                loadingEl.style.display = 'none';
                errorEl.style.display = 'none';
                selectorContainer.style.display = 'block';

            } catch (error) {
                console.error('Error al cargar datos:', error);
                mostrarError(error.message || 'No se pudieron cargar los datos. Verifica que la hoja de c√°lculo sea p√∫blica.');
            }
        }

        /* ============================================
           MANEJADOR: CAMBIO DE SELECCI√ìN
        ============================================ */
        nombreSelector.addEventListener('change', function() {
            const nombreSeleccionado = this.value;

            if (nombreSeleccionado) {
                // Actualizar informaci√≥n
                actualizarInformacion(nombreSeleccionado);

                // Generar tabla de premios
                generarTablaPremios(nombreSeleccionado);

                // Mostrar componentes con animaci√≥n
                infoCard.style.display = 'block';
                premiosTable.style.display = 'block';
            } else {
                // Ocultar componentes
                infoCard.style.display = 'none';
                premiosTable.style.display = 'none';
            }
        });

        /* ============================================
           INICIALIZACI√ìN
        ============================================ */
        // Cargar datos al inicio
        cargarDatos();

        // Configurar polling cada 5 minutos
        intervalId = setInterval(cargarDatos, POLLING_INTERVAL);

        // Limpiar intervalo al cerrar la p√°gina
        window.addEventListener('beforeunload', function() {
            if (intervalId) {
                clearInterval(intervalId);
            }
        });
    </script>
</body>
</html>
